<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>OpenCode Chat</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
    <!-- Top Status Bar -->
    <div class="status-bar" id="statusBar">
        <div class="status-info">
            <span class="status-dot" id="statusDot"></span>
            <span class="status-text" id="statusText">Initializing...</span>
            <button id="reconnectBtn" style="display: none; padding: 2px 8px; font-size: 11px; margin-left: 8px;" class="btn-primary">Reconnect</button>
        </div>
        <span class="session-name-display" id="sessionNameDisplay" style="display: none;">Session</span>
        <div style="display: flex; gap: 8px; align-items: center;">
            <button class="diff-btn" id="diffBtn" style="display: none;">
                <span id="diffBtnText">üìÑ Files</span>
                <span id="diffBadge" class="diff-badge" style="display: none;">0</span>
            </button>
            <button class="settings-btn" id="settingsBtn">‚öôÔ∏è</button>
        </div>
    </div>

    <!-- Main Container -->
    <div class="container">
        <!-- Tab Navigation -->
        <div class="tabs">
            <button class="tab-btn active" data-tab="chat">Chat</button>
            <button class="tab-btn" data-tab="events">Events</button>
            <button class="tab-btn" data-tab="tools">
                Tools
                <span class="tab-indicator" id="toolsTabIndicator" style="display: none;"></span>
            </button>
        </div>

        <!-- Chat Tab -->
        <div class="tab-content active" id="chatTab">
            <div class="messages-container" id="messagesContainer">
                <div class="welcome-message">
                    <h2>Welcome to OpenCode Chat</h2>
                    <p>Select a model/agent and start chatting</p>
                </div>
            </div>
            
            <!-- Quick Settings Bar -->
            <div class="quick-settings">
                <div class="qs-item">
                    <select id="qsAgentSelect" title="Change Agent">
                        <option value="">Agent: Default</option>
                    </select>
                </div>
                <div class="qs-item">
                    <select id="qsModelSelect" title="Change Model">
                        <option value="">Model: Default</option>
                    </select>
                </div>
                <button id="sendBtn" disabled>‚û§</button>
            </div>
            
            <div class="input-container" id="inputContainer">
                <!-- Simple Mode Input -->
                <div class="simple-input-wrapper" id="simpleInputWrapper">
                    <textarea 
                        id="messageInput" 
                        placeholder="Type a message..." 
                        rows="1"
                    ></textarea>
                    <button id="toggleRichBtn" class="toggle-rich-btn" title="Switch to Rich Editor">üìù</button>
                </div>

                <!-- Rich Mode Input -->
                <div class="rich-input-wrapper" id="richInputWrapper" style="display: none;">
                    <div class="markdown-toolbar" id="markdownToolbar">
                        <button class="md-btn" data-format="bold" title="Bold">B</button>
                        <button class="md-btn" data-format="italic" title="Italic">I</button>
                        <button class="md-btn" data-format="code" title="Inline Code">C</button>
                        <button class="md-btn" data-format="codeblock" title="Code Block">`</button>
                        <button class="md-btn" data-format="heading" title="Heading">#</button>
                        <button class="md-btn" data-format="list" title="List">L</button>
                        <button class="md-btn" data-format="indent" title="Increase Indent">‚Üí</button>
                        <button class="md-btn" data-format="outdent" title="Decrease Indent">‚Üê</button>
                        <div class="toolbar-spacer"></div>
                        <button id="toggleSimpleBtn" class="toggle-simple-btn">üíæ Simple</button>
                    </div>
                    <div 
                        id="richEditor" 
                        class="rich-editor" 
                        contenteditable="true" 
                        data-placeholder="Type a message with formatting..."
                    ></div>
                </div>

                <button id="abortBtn" title="Abort" style="background: var(--error-color); display: none;">üõë</button>
            </div>
        </div>

        <!-- Tools Tab -->
        <div class="tab-content" id="toolsTab">
            <div class="tools-header" style="padding: 12px 16px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h3 style="margin: 0; font-size: 16px;">Agent & Tool Activity</h3>
                    <div style="font-size: 12px; color: #666; margin-top: 4px;">
                        <span id="toolsActiveCount">0 active</span> ¬∑ <span id="toolsCompletedCount">0 completed</span>
                    </div>
                </div>
                <button class="btn-secondary" style="padding: 4px 12px; font-size: 12px;" id="clearToolsBtn">Clear All</button>
            </div>
            <div class="tools-container" id="toolsContainer">
                <div class="tools-empty-state">
                    <div style="font-size: 48px; margin-bottom: 16px;">üîß</div>
                    <div style="font-size: 16px; font-weight: 600; margin-bottom: 8px;">No Tools Running</div>
                    <div style="font-size: 13px; color: #666;">Agent and tool activity will appear here</div>
                </div>
            </div>
        </div>

        <!-- Events Tab -->
        <div class="tab-content" id="eventsTab">
            <div class="events-container" id="eventsContainer">
                <div class="event-item">
                    <div class="event-header">System</div>
                    <div class="event-body">Waiting for events...</div>
                    <div class="event-time" id="initialEventTime"></div>
                </div>
            </div>
        </div>

    </div>

    <!-- Settings Modal -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Session Settings</h3>
                <button class="close-btn" id="closeSettings">&times;</button>
            </div>
            
            <div class="settings-tabs">
                <button class="settings-tab-btn active" data-settings-tab="existing">Existing</button>
                <button class="settings-tab-btn" data-settings-tab="new">New Session</button>
                <button class="settings-tab-btn" data-settings-tab="preferences">Preferences</button>
                <button class="settings-tab-btn" data-settings-tab="logs">Logs</button>
            </div>

            <div class="modal-body">
                <div id="existingSessionsTab" class="settings-tab-content active">
                    <div class="form-group" style="margin-bottom: 12px;">
                        <input type="text" id="sessionSearch" placeholder="Search sessions by name..." autocomplete="off">
                    </div>
                    <div id="sessionList" class="session-list">
                        <div style="padding: 20px; text-align: center; color: #90949c;">Loading sessions...</div>
                    </div>
                </div>

                <div id="newSessionTab" class="settings-tab-content">
                    <div class="form-group">
                        <label for="agentSelect">Agent</label>
                        <select id="agentSelect">
                            <option value="">Default</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="modelSelect">Model</label>
                        <select id="modelSelect">
                            <option value="">Default</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="secondaryModelSelect">Secondary Model (Fallback)</label>
                        <select id="secondaryModelSelect">
                            <option value="">None</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="directoryInput">Directory</label>
                        <input type="text" id="directoryInput" value="/root" autocomplete="off" spellcheck="false">
                    </div>
                    <button class="btn-primary" id="createSessionBtn" style="width: 100%;">Create New Session</button>
                </div>

                <div id="preferencesTab" class="settings-tab-content">
                    <div class="form-group">
                        <label class="toggle-label">
                            <input type="checkbox" id="showReasoning">
                            <span class="toggle-text">Show Reasoning</span>
                        </label>
                        <small style="color: #90949c; font-size: 12px; margin-top: 4px; display: block;">
                            Display internal reasoning process in messages
                        </small>
                    </div>
                    <div class="form-group">
                        <label class="toggle-label">
                            <input type="checkbox" id="darkTheme">
                            <span class="toggle-text">Dark Mode</span>
                        </label>
                        <small style="color: #90949c; font-size: 12px; margin-top: 4px; display: block;">
                            Use dark color scheme
                        </small>
                    </div>
                </div>

                <div id="logsTab" class="settings-tab-content">
                    <div class="logs-controls" style="padding: 10px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;">
                        <span id="logCount">0 events</span>
                        <button class="btn-primary" style="padding: 4px 12px; font-size: 12px;" id="refreshLogs">Refresh</button>
                    </div>
                    <div class="logs-container" id="logsContainer" style="max-height: 400px; overflow-y: auto; padding: 10px; font-family: monospace; font-size: 11px;">
                        <div class="log-item">No logs captured yet.</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Auth Error Modal -->
    <div class="modal" id="authModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Authentication Failed</h3>
                <button class="close-btn" id="closeAuth">&times;</button>
            </div>
            <div class="modal-body">
                <div style="text-align: center; margin-bottom: 20px;">
                    <div style="font-size: 48px; margin-bottom: 10px;">üîê</div>
                    <p style="font-size: 16px; margin-bottom: 10px;">The provider rejected your credentials.</p>
                    <p style="color: #666;">Please check your API key in the OpenCode settings or provider configuration.</p>
                </div>
                <div style="background: #f5f5f5; padding: 10px; border-radius: 4px; margin-bottom: 20px; font-family: monospace; font-size: 12px; color: #d32f2f;" id="authErrorDetails">
                    Error details...
                </div>
                <button class="btn-primary" onclick="window.location.reload()">Reload</button>
            </div>
        </div>
    </div>

    <!-- Edit Session Modal -->
    <div class="modal" id="editSessionModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit Session Name</h3>
                <button class="close-btn" id="closeEditSession">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="sessionNameInput">Session Name</label>
                    <input type="text" id="sessionNameInput" placeholder="Enter session name..." autocomplete="off" spellcheck="false">
                    <div class="session-id-hint" id="sessionIdHint"></div>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                    <button class="btn-secondary" id="cancelEditSession">Cancel</button>
                    <button class="btn-primary" id="saveSessionName">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Message Modal -->
    <div class="modal" id="editMessageModal">
        <div class="modal-content modal-wide">
            <div class="modal-header">
                <h3>Edit & Resend Message</h3>
                <button class="close-btn" id="closeEditMessage">&times;</button>
            </div>
            <div class="modal-body">
                <div class="markdown-toolbar" id="editMarkdownToolbar">
                    <button class="md-btn" data-format="bold" title="Bold">B</button>
                    <button class="md-btn" data-format="italic" title="Italic">I</button>
                    <button class="md-btn" data-format="code" title="Inline Code">C</button>
                    <button class="md-btn" data-format="codeblock" title="Code Block">`</button>
                    <button class="md-btn" data-format="heading" title="Heading">#</button>
                    <button class="md-btn" data-format="list" title="List">L</button>
                    <button class="md-btn" data-format="indent" title="Increase Indent">‚Üí</button>
                    <button class="md-btn" data-format="outdent" title="Decrease Indent">‚Üê</button>
                </div>
                <div 
                    id="editRichEditor" 
                    class="rich-editor edit-rich-editor" 
                    contenteditable="true"
                ></div>
                <div class="edit-warning">
                    ‚ö†Ô∏è This will send as a new message with your edits
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 16px;">
                    <button class="btn-secondary" id="cancelEditMessage">Cancel</button>
                    <button class="btn-primary" id="resendMessageBtn">Resend Message</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Diff Drawer -->
    <div class="diff-drawer" id="diffDrawer">
        <div class="diff-drawer-header">
            <h3 id="diffDrawerTitle">Files Changed (0)</h3>
            <button class="diff-drawer-close" id="diffDrawerClose">‚úï</button>
        </div>
        
        <div class="diff-drawer-content" id="diffDrawerContent">
            <div class="diff-empty-state">
                No file changes yet
            </div>
        </div>
        
        <div class="diff-drawer-footer">
            <button class="btn-primary" id="clearDiffBtn">Clear All</button>
        </div>
    </div>

    <!-- Drawer overlay for mobile -->
    <div class="diff-drawer-overlay" id="diffDrawerOverlay"></div>

    <!-- Toast Notification Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Tool/Agent Output Modal -->
    <div class="modal" id="toolOutputModal">
        <div class="modal-content" style="max-width: 80%; max-height: 80%;">
            <div class="modal-header">
                <h3 id="toolOutputTitle">Tool Output</h3>
                <button class="close-modal" onclick="document.getElementById('toolOutputModal').style.display='none'">&times;</button>
            </div>
            <div class="modal-body" style="max-height: 60vh; overflow-y: auto;">
                <pre id="toolOutputContent" style="white-space: pre-wrap; word-wrap: break-word; font-family: monospace; font-size: 12px; background: #f5f5f5; padding: 10px; border-radius: 4px;"></pre>
            </div>
        </div>
    </div>

    <script src="app.js"></script>
</body>
</html>
